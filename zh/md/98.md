# ID: 98 - PHP程序中包含/要求语句的文件名控制不当(“PHP远程文件包含”)
<h5>名称</h5>PHP程序中包含/要求语句的文件名控制不当(“PHP远程文件包含”)
<h5>弱点抽象</h5>底座
<h5>状态</h5>草案
<h5>描述</h5>PHP应用程序从上游组件接收输入，但在使用Required、Include或类似函数之前，它不会限制或错误地限制输入。
<h5>扩展描述</h5>在PHP的某些版本和配置中，这允许攻击者指定一个到远程位置的URL，软件将从该位置获取要执行的代码。在与路径遍历相关的其他情况下，攻击者可以指定一个本地文件，该文件可能包含可由PHP解析的可执行语句。
<h5>相关的弱点</h5>：：NATURE：ChildOf：CWE ID：706：VIEW ID：1000：：NATURE：ChildOf：CWE ID：829：VIEW ID：699：ORDINAL：Primary：：NATURE：ChildOf：CWE ID：829：VIEW ID：1000：ORDINAL：Primary：：NATURE：CanPrecede：CWE ID：94：VIEW ID：1000：：NATURE：CanPrecede：CWE ID：94：VIEW ID：699：：NATURE：CanAlsoBe：CWE ID：426：VIEW ID：1000：：NATURE：PeerOf：CWE ID：216：VIEW ID：1000：：
<h5>弱点规律</h5>空
<h5>适用的平台</h5>*语言名称：PHP：语言流行率：通常：
<h5>背景细节</h5>空
<h5>替代条款</h5>*术语：远程文件include：DESCRIPTION：TERM：RFI：DESCRIPTION：The远程文件包含(RFI)缩写经常被漏洞研究人员使用。：术语：本地文件包含：描述：此术语经常用于远程下载被禁用的情况，或者文件名的第一部分不受攻击者控制时，攻击者强制使用相对路径遍历(CWE-23)攻击技术来访问可能包含先前注入的PHP代码的文件，例如Web访问日志：
<h5>模式的介绍</h5>：PHASE：Implementation：DESCRIPTION：PHASE：Architecture和设计：描述：
<h5>剥削因素</h5>空
<h5>利用的可能性</h5>空
<h5>常见的后果</h5>：：SCOPE：Integrity：SCOPE：Confidentiality：SCOPE：Availability：TECHNICAL影响：执行未经授权的代码或命令：注意：完整性、机密性、可用性、执行未经授权的代码或命令攻击者可以指定要从远程位置执行的任意代码。或者，也可以使用正常的程序行为将php代码插入到本地计算机上的文件中，然后本地机器上的文件可以包含这些代码并强制代码执行，因为php忽略了文件中的所有内容，除了php说明符之间的内容。
<h5>检测方法</h5>*方法：手工Analysis：EFFECTIVENESS：High：DESCRIPTION：Manual白盒分析可以非常有效地发现这个问题，因为在每个程序中通常只有相对较少的包含或要求语句。：方法：自动静态分析：有效性：描述：文件名的外部控制或影响通常可以通过自动静态分析来检测，这种静态分析可以建模软件内的数据流。自动静态分析可能无法识别何时执行适当的输入验证，从而导致错误-即没有任何安全后果或需要进行任何代码更改的警告。如果程序使用自定义的输入验证库，那么一些工具可能允许分析人员创建自定义签名以检测这些例程的使用情况。
<h5>潜在的缓解措施</h5>::PHASE:Architecture and Design:STRATEGY:Libraries or Frameworks:EFFECTIVENESS::DESCRIPTION:Use a vetted library or framework that does not allow this weakness to occur or provides constructs that make this weakness easier to avoid.::PHASE:Architecture and Design:STRATEGY:Enforcement by Conversion:EFFECTIVENESS::DESCRIPTION:When the set of acceptable objects, such as filenames or URLs, is limited or known, create a mapping from a set of fixed input values (such as numeric IDs) to the actual filenames or URLs, and reject all other inputs. For example, ID 1 could map to inbox.txt and ID 2 could map to profile.txt. Features such as the ESAPI AccessReferenceMap [REF-185] provide this capability.::PHASE:Architecture and Design:STRATEGY::EFFECTIVENESS::DESCRIPTION:For any security checks that are performed on the client side, ensure that these checks are duplicated on the server side, in order to avoid CWE-602. Attackers can bypass the client-side checks by modifying values after the checks have been performed, or by changing the client to remove the client-side checks entirely. Then, these modified values would be submitted to the server.::PHASE:Architecture and Design Operation:STRATEGY:Sandbox or Jail:EFFECTIVENESS:Limited:DESCRIPTION:Run the code in a jail or similar sandbox environment that enforces strict boundaries between the process and the operating system. This may effectively restrict which files can be accessed in a particular directory or which commands can be executed by the software. OS-level examples include the Unix chroot jail, AppArmor, and SELinux. In general, managed code may provide some protection. For example, java.io.FilePermission in the Java SecurityManager allows the software to specify restrictions on file operations. This may not be a feasible solution, and it only limits the impact to the operating system; the rest of the application may still be subject to compromise. Be careful to avoid CWE-243 and other weaknesses related to jails.::PHASE:Architecture and Design Operation:STRATEGY:Environment Hardening:EFFECTIVENESS::DESCRIPTION:Run your code using the lowest privileges that are required to accomplish the necessary tasks [REF-76]. If possible, create isolated accounts with limited privileges that are only used for a single task. That way, a successful attack will not immediately give the attacker access to the rest of the software or its environment. For example, database applications rarely need to run as the database administrator, especially in day-to-day operations.::PHASE:Implementation:STRATEGY:Input Validation:EFFECTIVENESS::DESCRIPTION:Assume all input is malicious. Use an accept known good input validation strategy, i.e., use a whitelist of acceptable inputs that strictly conform to specifications. Reject any input that does not strictly conform to specifications, or transform it into something that does. When performing input validation, consider all potentially relevant properties, including length, type of input, the full range of acceptable values, missing or extra inputs, syntax, consistency across related fields, and conformance to business rules. As an example of business rule logic, boat may be syntactically valid because it only contains alphanumeric characters, but it is not valid if the input is only expected to contain colors such as red or blue. Do not rely exclusively on looking for malicious or malformed inputs (i.e., do not rely on a blacklist). A blacklist is likely to miss at least one undesirable input, especially if the code's environment changes. This can give attackers enough room to bypass the intended validation. However, blacklists can be useful for detecting potential attacks or determining which inputs are so malformed that they should be rejected outright. When validating filenames, use stringent whitelists that limit the character set to be used. If feasible, only allow a single . character in the filename to avoid weaknesses such as CWE-23, and exclude directory separators such as / to avoid CWE-36. Use a whitelist of allowable file extensions, which will help to avoid CWE-434. Do not rely exclusively on a filtering mechanism that removes potentially dangerous characters. This is equivalent to a blacklist, which may be incomplete (CWE-184). For example, filtering / is insufficient protection if the filesystem also supports the use of as a directory separator. Another possible error could occur when the filtering is applied in a way that still produces dangerous data (CWE-182). For example, if ../ sequences are removed from the .../...// string in a sequential fashion, two instances of ../ would be removed from the original string, but the remaining characters would still form the ../ string.::PHASE:Architecture and Design Operation:STRATEGY:Attack Surface Reduction:EFFECTIVENESS::DESCRIPTION:Store library, include, and utility files outside of the web document root, if possible. Otherwise, store them in a separate directory and use the web server's access control capabilities to prevent attackers from directly requesting them. One common practice is to define a fixed constant in each calling program, then check for the existence of the constant in the library/include file; if the constant does not exist, then the file was directly requested, and it can exit immediately. This significantly reduces the chance of an attacker being able to bypass any protection mechanisms that are in the base program but not in the include files. It will also reduce the attack surface.::PHASE:Architecture and Design Implementation:STRATEGY:Attack Surface Reduction:EFFECTIVENESS::DESCRIPTION:Understand all the potential areas where untrusted inputs can enter your software: parameters or arguments, cookies, anything read from the network, environment variables, reverse DNS lookups, query results, request headers, URL components, e-mail, files, filenames, databases, and any external systems that provide data to the application. Remember that such inputs may be obtained indirectly through API calls. Many file inclusion problems occur because the programmer assumed that certain inputs could not be modified, especially for cookies and URL components.::PHASE:Operation:STRATEGY:Firewall:EFFECTIVENESS:Moderate:DESCRIPTION:Use an application firewall that can detect attacks against this weakness. It can be beneficial in cases in which the code cannot be fixed (because it is controlled by a third party), as an emergency prevention measure while more comprehensive software assurance measures are applied, or to provide defense in depth.::PHASE:Operation Implementation:STRATEGY:Environment Hardening:EFFECTIVENESS::DESCRIPTION:Develop and run your code in the most recent versions of PHP available, preferably PHP 6 or later. Many of the highly risky features in earlier PHP interpreters have been removed, restricted, or disabled by default.::PHASE:Operation Implementation:STRATEGY:Environment Hardening:EFFECTIVENESS::DESCRIPTION:When using PHP, configure the application so that it does not use register_globals. During implementation, develop the application so that it does not rely on this feature, but be wary of implementing a register_globals emulation that is subject to weaknesses such as CWE-95, CWE-621, and similar issues. Often, programmers do not protect direct access to files intended only to be included by core programs. These include files may assume that critical variables have already been initialized by the calling program. As a result, the use of register_globals combined with the ability to directly access the include file may allow attackers to conduct file inclusion attacks. This remains an extremely common pattern as of 2009.::PHASE:Operation:STRATEGY:Environment Hardening:EFFECTIVENESS:High:DESCRIPTION:Set allow_url_fopen to false, which limits the ability to include files from remote locations.::
<h5>观察到的例子</h5>::REFERENCE:CVE-2004-0285:DESCRIPTION:Modification of assumed-immutable configuration variable in include file allows file inclusion via direct request.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2004-0285REFERENCE:CVE-2004-0030:DESCRIPTION:Modification of assumed-immutable configuration variable in include file allows file inclusion via direct request.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2004-0030REFERENCE:CVE-2004-0068:DESCRIPTION:Modification of assumed-immutable configuration variable in include file allows file inclusion via direct request.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2004-0068REFERENCE:CVE-2005-2157:DESCRIPTION:Modification of assumed-immutable configuration variable in include file allows file inclusion via direct request.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-2157REFERENCE:CVE-2005-2162:DESCRIPTION:Modification of assumed-immutable configuration variable in include file allows file inclusion via direct request.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-2162REFERENCE:CVE-2005-2198:DESCRIPTION:Modification of assumed-immutable configuration variable in include file allows file inclusion via direct request.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-2198REFERENCE:CVE-2004-0128:DESCRIPTION:Modification of assumed-immutable variable in configuration script leads to file inclusion.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2004-0128REFERENCE:CVE-2005-1864:DESCRIPTION:PHP file inclusion.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-1864REFERENCE:CVE-2005-1869:DESCRIPTION:PHP file inclusion.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-1869REFERENCE:CVE-2005-1870:DESCRIPTION:PHP file inclusion.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-1870REFERENCE:CVE-2005-2154:DESCRIPTION:PHP local file inclusion.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-2154REFERENCE:CVE-2002-1704:DESCRIPTION:PHP remote file include.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2002-1704REFERENCE:CVE-2002-1707:DESCRIPTION:PHP remote file include.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2002-1707REFERENCE:CVE-2005-1964:DESCRIPTION:PHP remote file include.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-1964REFERENCE:CVE-2005-1681:DESCRIPTION:PHP remote file include.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-1681REFERENCE:CVE-2005-2086:DESCRIPTION:PHP remote file include.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-2086REFERENCE:CVE-2004-0127:DESCRIPTION:Directory traversal vulnerability in PHP include statement.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2004-0127REFERENCE:CVE-2005-1971:DESCRIPTION:Directory traversal vulnerability in PHP include statement.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-1971REFERENCE:CVE-2005-3335:DESCRIPTION:PHP file inclusion issue, both remote and local; local include uses .. and %00 characters as a manipulation, but many remote file inclusion issues probably have this vector.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2005-3335REFERENCE:CVE-2009-1936:DESCRIPTION:chain: library file sends a redirect if it is directly requested but continues to execute, allowing remote file inclusion and path traversal.:LINK:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-1936
<h5>功能区域</h5>空
<h5>影响资源</h5>档案或目录：
<h5>分类法映射</h5>分类名称：plover：条目名称：PHP文件包括：分类法名称：OWASP前十名2007：条目ID：A3：条目名称：映射FIT：CWE更具体：分类法名称：WASC：条目ID：5：条目名称：远程文件包含：
<h5>相关的攻击模式</h5>*193：
<h5>笔记</h5>类型：关系：注意：这通常是其他弱点的功能性后果。它通常是多因素与其他因素(如女佣)，虽然并非所有的包含错误涉及假定不变的数据。直接请求的弱点经常起作用。可以重叠目录遍历中的局部包含问题。：类型：研究空白：注意：研究不足和报道不足。其他具有Required和Included功能的解释语言也可能产生易受攻击的应用程序，但截至2007年，PHP一直是关注的焦点。使用可执行文件扩展名的任何可访问语言都可能存在这种问题，例如ASP，因为.asp扩展名通常是可执行的。Perl等语言不太可能出现这些问题，因为.pl扩展并不总是配置为可由Web服务器执行。

